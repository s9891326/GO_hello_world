# 第十三章練習題

## 練習 1：生產者-消費者隊列

實現一個完整的生產者-消費者隊列系統：

要求：
- 支援多生產者多消費者模式
- 實現優先級隊列功能
- 添加隊列容量限制和背壓控制
- 實現消息確認機制
- 支援隊列狀態監控和統計
- 添加優雅關閉功能

## 練習 2：工作調度器

創建一個基於通道的任務調度系統：

要求：
- 實現任務優先級排序
- 支援定時任務和延遲任務
- 實現工作池動態調整
- 添加任務執行狀態追蹤
- 支援任務取消和重試機制
- 實現調度器的監控面板

## 練習 3：請求/響應模式

實現一個請求-響應通信系統：

要求：
- 支援異步請求處理
- 實現請求超時機制
- 支援請求追蹤和關聯
- 添加負載均衡功能
- 實現斷路器模式
- 支援請求重試和冪等性

## 練習 4：事件總線系統

設計一個基於通道的事件發佈訂閱系統：

要求：
- 支援主題訂閱和通配符匹配
- 實現事件過濾和轉換
- 支援持久化訂閱者
- 添加事件重放功能
- 實現背壓控制和流控制
- 支援事件統計和監控

## 練習 5：流式數據處理

創建一個流式數據處理管道：

要求：
- 實現可組合的處理階段
- 支援並行處理和背壓
- 添加錯誤處理和恢復
- 實現窗口化操作
- 支援流的分割和合併
- 添加處理進度監控

## 練習 6：分佈式鎖系統

實現一個基於通道的分佈式鎖：

要求：
- 支援可重入鎖
- 實現鎖超時和自動釋放
- 添加鎖等待隊列
- 支援讀寫鎖模式
- 實現死鎖檢測
- 添加鎖使用統計

## 提示

1. 合理選擇緩衝通道和無緩衝通道
2. 使用 select 語句處理多通道操作
3. 正確處理通道關閉和清理
4. 避免通道洩漏和死鎖
5. 使用 context 進行超時和取消控制
6. 實現優雅的錯誤處理和恢復機制

## 預期輸出範例

### 練習 1 輸出：
```
=== 生產者-消費者隊列測試 ===
啟動隊列系統，容量: 100

生產者統計：
  生產者 1: 已生產 45 條消息
  生產者 2: 已生產 38 條消息
  生產者 3: 已生產 52 條消息

消費者統計：
  消費者 1: 已消費 42 條消息
  消費者 2: 已消費 48 條消息
  消費者 3: 已消費 45 條消息

隊列狀態：
  當前大小: 15/100
  待處理高優先級: 3
  待處理普通優先級: 12
  總吞吐量: 1,250 msg/sec
  平均延遲: 25ms

確認統計：
  已確認: 128
  待確認: 7
  確認超時: 2
```

### 練習 2 輸出：
```
=== 工作調度器測試 ===
調度器啟動，工作池大小: 5

任務統計：
  排隊任務: 23
  執行中任務: 5
  已完成任務: 127
  失敗任務: 3

優先級隊列：
  [高優先級] 數據同步任務 - 預計 2分鐘
  [中優先級] 報告生成任務 - 預計 5分鐘
  [低優先級] 日誌清理任務 - 預計 30秒

工作池狀態：
  Worker 1: 執行 "用戶數據處理" (進度: 65%)
  Worker 2: 執行 "文件上傳處理" (進度: 23%)
  Worker 3: 空閒
  Worker 4: 執行 "郵件發送" (進度: 90%)
  Worker 5: 空閒

調度統計：
  平均等待時間: 45秒
  平均執行時間: 2分30秒
  成功率: 97.6%
```

### 練習 4 輸出：
```
=== 事件總線測試 ===
事件總線啟動

訂閱者狀態：
  user.* -> 3個訂閱者
  order.created -> 2個訂閱者
  payment.* -> 1個訂閱者
  *.error -> 4個訂閱者

事件流：
  09:15:23 - user.login (訂閱者: 3) ✅
  09:15:24 - order.created (訂閱者: 2) ✅
  09:15:25 - payment.failed (訂閱者: 2) ✅
  09:15:26 - system.error (訂閱者: 4) ✅

處理統計：
  總事件數: 1,456
  成功分發: 1,445
  分發失敗: 11
  平均延遲: 12ms
  背壓事件: 23

訂閱者健康狀態：
  ✅ UserService: 正常 (延遲: 5ms)
  ✅ OrderService: 正常 (延遲: 8ms)
  ⚠️ PaymentService: 延遲 (延遲: 150ms)
  ❌ LogService: 離線
```